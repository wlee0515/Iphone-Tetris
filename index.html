<!DOCTYPE html>
<html manifest="tetris.manifest">

<head>
  <!--
    https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html
  -->
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <!--
    Sets whether a web application runs in full-screen mode.

    If content is set to yes, the web application runs in full-screen mode; otherwise, it does not. The default behavior is to use Safari to display web content.
    You can determine whether a webpage is displayed in full-screen mode using the window.navigator.standalone read-only Boolean JavaScript property.
  -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <!--
    Sets the style of the status bar for a web application.

    This meta tag has no effect unless you first specify full-screen mode as described in apple-apple-mobile-web-app-capable.
    If content is set to default, the status bar appears normal.
    If set to black, the status bar has a black background.
    If set to black-translucent, the status bar is black and translucent.
    If set to default or black, the web content is displayed below the status bar.
    If set to black-translucent, the web content is displayed on the entire screen, partially obscured by the status bar.
    The default value is default.
  -->
  <link rel="apple-touch-icon" href="favicon.ico" />

  <!-- startup image needs to be defined for each iphone resolution, determineable by media query-->
  <!--
  <link rel="apple-touch-startup-image" href="startup.png" />

  -->
  <title>Wlee0515 Tetris</title>

  <style>
    body {
      overflow: hidden;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;

      background-image: url("startup.png"); 
      background-position: center;  
      background-repeat: no-repeat; 
      background-size: cover; 
      background-color: black; /*this is the color of the navbar*/
 
      /* disable selection to prevent selecting the view port*/
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;

    }

    #debug_div {
      position: fixed;
      top: 0;
      left: 0;
      background: rgba(255, 255, 255, 0.75);
    }

    #viewport_div {
      /* Make this default to 100%, will scale on resize*/
      width: 100%;
      height: 100%;
      overflow: hidden;

      /* fix position to the bottom to account for the dynamically changing bottom nav bar in safari*/
      position: fixed; 
      bottom: 0;
    }

    #viewport {
    }

  </style>
  <script>

    var gGlobal = {
      viewportId : "viewport",
      debugId : "debug_div",
    };

    var blockColor  = [
      "rgba(255,255,255,0.0)",
      "rgba(255,0,0,1)",
      "rgba(0,255,0,1)",
      "rgba(0,0,255,1)",
      "rgba(255,255,0,1)",
      "rgba(255,0,255,1)",
      "rgba(0,255,255,1)",
      "rgba(255,255,0,1)",
    ];

    var blockShape = [
      [],
      [[0,0],[0,1],[1,0],[1,1]],
      [[0,0],[0,1],[-1,0],[1,0]],
      [[0,0],[0,1],[1,1],[-1,0]],
      [[0,0],[0,1],[-1,1],[1,0]],
      [[0,0],[-1,1],[-1,0],[1,0]],
      [[0,0],[1,1],[1,0],[-1,0]],
      [[0,0],[0,1],[0,2],[0,-1]],
    ]

    var gActiveBlock = {
      blockIndex : 1,
      blockShape : blockShape[1],
      blockCenter : [0,0]      
    }

    var gBoard = {
      x : 0,
      y : 0,
      height : 25,
      width : 10,
      data : [],
      backgroundColor : "rgba(255,255,255,0.80)",
      borderColor : "black",
      xLimit : [0,10],
      yLimit : [0,25],
      
    };

    var rotateRight = [[0,-1],[1,0]];
    var rotateLeft = [[0,1],[-1,0]];

    function rotateArray( iRotation, iArray ) {
      var ret = [];
      for( var i = 0; i < iArray.length; ++i) {
        ret.push([iRotation[0][1]*iArray[i][0] + iRotation[0][1]*iArray[i][1], iRotation[1][1]*iArray[i][0] + iRotation[1][1]*iArray[i][1] ]);
      }
      return ret;
    }

    function render() {
        
      var wCanvas = document.getElementById(gGlobal.viewportId);
      var wCtx = wCanvas.getContext("2d");
      
      if (null == wCtx) return;

      wCtx.clearRect(0, 0, wCanvas.clientWidth, wCanvas.clientHeight );
      var wCenterX = wCanvas.clientWidth/2;
      var wCenterY = wCanvas.clientHeight/2;
      var wBlockSizeW = Math.floor( wCanvas.clientWidth/(gBoard.width + 5));
      var wBlockSizeH = Math.floor( wCanvas.clientHeight/(gBoard.height + 5));
      var wBlockSize = wBlockSizeW < wBlockSizeH ? wBlockSizeW : wBlockSizeH;

      var wBoardWidth = gBoard.width*wBlockSize;
      var wBoardHeight = gBoard.height*wBlockSize;

      var wBoardCorners = [
        [gBoard.x - wBoardWidth/2, gBoard.y - wBoardHeight/2 ],
        [gBoard.x - wBoardWidth/2, gBoard.y + wBoardHeight/2 ],
        [gBoard.x + wBoardWidth/2, gBoard.y + wBoardHeight/2 ],
        [gBoard.x + wBoardWidth/2, gBoard.y - wBoardHeight/2 ],
      ];
      
//      gBoard.xLimit = [ - Math.floor((wCenterX + wBoardCorners[1][0])/wBlockSize), Math.floor((wCenterX - wBoardCorners[1][0]) /wBlockSize) ];
//      gBoard.yLimit = [- Math.floor((wCenterY - wBoardCorners[1][1])/wBlockSize) , Math.floor((wCenterY + wBoardCorners[1][1])/wBlockSize)];

      wCtx.fillStyle = gBoard.backgroundColor;
      wCtx.fillRect(wBoardCorners[0][0] + wCenterX, wBoardCorners[0][1] + wCenterY, wBoardWidth, wBoardHeight);
      wCtx.moveTo( wBoardCorners[0][0] + wCenterX, wBoardCorners[0][1] + wCenterY);

      for( var i = 1; i < wBoardCorners.length; ++i) {
        wCtx.lineTo(wBoardCorners[i][0] + wCenterX, wBoardCorners[i][1] + wCenterY);
      }
      wCtx.strokeStyle = gBoard.borderColor;
      wCtx.lineWidth = 3;
      wCtx.stroke();
      
      wCtx.strokeStyle = "dark grey";
      wCtx.lineWidth = 2;
      var wAnchorX = wBoardCorners[1][0] + wCenterX;
      var wAnchorY = wBoardCorners[1][1] + wCenterY - wBlockSize;
      var wBlockRadius = wBlockSize/5;
      for( var i = 0; i < gBoard.data.length; ++i) {
        for( var k = 0; k < gBoard.data[i].length; ++k) {
          if (0 == gBoard.data[i][k]) continue;
          wCtx.fillStyle = blockColor[gBoard.data[i][k]];
          wCtx.beginPath();
          wCtx.roundRect(wAnchorX + k*wBlockSize, wAnchorY - i*wBlockSize, wBlockSize, wBlockSize, wBlockRadius);
          wCtx.fill();
          wCtx.stroke();
        }
      }

      wCtx.fillStyle = blockColor[gActiveBlock.blockIndex];
      for( var i = 0; i < gActiveBlock.blockShape.length; ++i) {
        var x = gActiveBlock.blockShape[i][0] + gActiveBlock.blockCenter[0];
        var y = gActiveBlock.blockShape[i][1] + gActiveBlock.blockCenter[1];
        
        wCtx.beginPath();
        wCtx.roundRect(wAnchorX + x*wBlockSize, wAnchorY - y*wBlockSize, wBlockSize, wBlockSize, wBlockRadius);
        wCtx.fill();
        wCtx.stroke();

      }

      window.requestAnimationFrame(render);
    }

    function resize() {
      
      //change the size of the Canvas tomatch sceen size. Canvas Parent height = top of window - bottom of Parent Element bottom because Parent Element Bottom is fixed to top of the bottom navBar 
      var wCanvas = document.getElementById(gGlobal.viewportId);
      wCanvas.parentElement.height = wCanvas.parentElement.getBoundingClientRect.bottom;
      wCanvas.parentElement.width = window.innerWidth;

      if (null != wCanvas) {
        wCanvas.height = wCanvas.parentElement.clientHeight;
        wCanvas.width = wCanvas.parentElement.clientWidth;
      }
    }

    function init() {
      resize();
      gBoard.data = [];
      for (var i = 0; i < gBoard.height; ++i) {
        var newRow = new Int16Array(gBoard.width);
        for (var k = 0; k < newRow.length; ++k) {
          //newRow[k] = Math.floor(Math.random()*blockColor.length);
          newRow[k] = 0;
        }
        gBoard.data.push(newRow);
      }
      
      window.requestAnimationFrame(render);
    }
    
    function testPosition( iNewCenter, iShape) {
      for( var i = 0; i < iShape.length; ++i) {
        var y = iShape[i][1] + iNewCenter[1];
        if ( y < 0 ) return false;
        if ( y >= gBoard.data.length ) return false;

        var x = iShape[i][0] + iNewCenter[0];        
        if ( x < 0 ) return false;
        if ( x >= gBoard.data[y].length ) return false;

        if (0 != gBoard.data[y][x]) return false;
      }

      return true;
    }

    function moveX(iDx) {
      var sign = iDx/Math.abs(iDx);
      var mag = Math.abs(iDx);
      for( var i = mag; i >= 0; --i ) {
        var newCenter = [gActiveBlock.blockCenter[0] + sign*i, gActiveBlock.blockCenter[1]];
        if (true == testPosition(newCenter, gActiveBlock.blockShape)) {
          gActiveBlock.blockCenter = newCenter;
        }
      }
    }
    
    function moveY(iDy) {
      
      var sign = iDy/Math.abs(iDy);
      var mag = Math.abs(iDy);
      for( var i = mag; i >= 0; --i ) {
        var newCenter = [gActiveBlock.blockCenter[0], gActiveBlock.blockCenter[1] + sign*i];
        if (true == testPosition(newCenter, gActiveBlock.blockShape)) {
          gActiveBlock.blockCenter = newCenter;
        }
      }
     }
    window.addEventListener("load", init);
    window.addEventListener("resize", resize);
    document.addEventListener('keydown', function(event) {
      if(event.keyCode == 37) {
        moveX(-1);
      }
      else if(event.keyCode == 39) {
        moveX(1);
      }
      else if(event.keyCode == 40) {
        moveY(-1);
      }
      else if(event.keyCode == 38) {
        moveY(1);
        //gActiveBlock.blockShape = rotateArray(rotateRight, gActiveBlock.blockShape);
      }
    });
  </script>
</head>
<body>
  <div id="viewport_div">
    <canvas id="viewport"></canvas>
  </div>
  <div id="debug_div"></div>
</body>
</html>
